ARG QATLIB_VERSION="22.07.0"
ARG QAT_ENGINE_VERSION="v0.6.13"
ARG ASYNC_NGINX_VERSION="v0.4.7"
ARG IPSEC_MB_VERSION="v1.2"
ARG IPP_CRYPTO_VERSION="ippcp_2021.5"

RUN apt update && \
    env DEBIAN_FRONTEND=noninteractive apt install -y \
    libudev-dev \
    make \
    gcc \
    g++ \
    nasm \
    pkg-config \
    libssl-dev \
    zlib1g-dev \
    wget \
    git \
    yasm \
    autoconf \
    cmake \
    libtool && \
    git clone --depth 1 -b $ASYNC_NGINX_VERSION https://github.com/intel/asynch_mode_nginx.git && \
    git clone --depth 1 -b $QAT_ENGINE_VERSION https://github.com/intel/QAT_Engine && \
    git clone --depth 1 -b $IPP_CRYPTO_VERSION https://github.com/intel/ipp-crypto && \
    git clone --depth 1 -b $IPSEC_MB_VERSION https://github.com/intel/intel-ipsec-mb && \
    git clone --depth 1 -b $QATLIB_VERSION https://github.com/intel/qatlib && \
    git clone https://github.com/openresty/lua-nginx-module && mv lua-nginx-module /usr/local/

RUN cd /qatlib && \
    ./autogen.sh && \
    ./configure \
    --prefix=/usr \
    --enable-systemd=no && \
    make -j && \
    make install samples-install

RUN cd /ipp-crypto/sources/ippcp/crypto_mb && \
    cmake . -B"../build" \
    -DOPENSSL_INCLUDE_DIR=/usr/include/openssl \
    -DOPENSSL_LIBRARIES=/usr/lib64 \
    -DOPENSSL_ROOT_DIR=/usr/bin/openssl && \
    cd ../build && \
    make crypto_mb && make install
RUN cd /intel-ipsec-mb && \
    make && make install LIB_INSTALL_DIR=/usr/lib64

RUN cd /QAT_Engine && \
    ./autogen.sh && \
    ./configure && \
    make && make install
    #--enable-qat_sw \
    #--with-qat_sw_install_dir=/usr/local && \
    #make && make install



CMD ["nginx", "-g", "daemon off;"]

STOPSIGNAL SIGQUIT
